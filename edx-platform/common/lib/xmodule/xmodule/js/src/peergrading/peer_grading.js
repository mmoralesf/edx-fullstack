// Generated by CoffeeScript 1.6.1
(function() {
  var _this = this;

  this.PeerGrading = (function() {

    PeerGrading.prototype.peer_grading_sel = '.peer-grading';

    PeerGrading.prototype.peer_grading_container_sel = '.peer-grading-container';

    PeerGrading.prototype.error_container_sel = '.error-container';

    PeerGrading.prototype.message_container_sel = '.message-container';

    PeerGrading.prototype.problem_button_sel = '.problem-button';

    PeerGrading.prototype.problem_list_sel = '.problem-list';

    PeerGrading.prototype.progress_bar_sel = '.progress-bar';

    function PeerGrading(element) {
      var _this = this;
      this.activate_problem = function() {
        return PeerGrading.prototype.activate_problem.apply(_this, arguments);
      };
      this.show_results = function(event) {
        return PeerGrading.prototype.show_results.apply(_this, arguments);
      };
      this.construct_progress_bar = function() {
        return PeerGrading.prototype.construct_progress_bar.apply(_this, arguments);
      };
      this.el = element;
      this.peer_grading_container = this.$(this.peer_grading_sel);
      this.use_single_location = this.peer_grading_container.data('use-single-location');
      this.peer_grading_outer_container = this.$(this.peer_grading_container_sel);
      this.ajax_url = this.peer_grading_container.data('ajax-url');
      if (this.use_single_location.toLowerCase() === "true") {
        this.activate_problem();
      } else {
        this.error_container = this.$(this.error_container_sel);
        this.error_container.toggle(!this.error_container.is(':empty'));
        this.message_container = this.$(this.message_container_sel);
        this.message_container.toggle(!this.message_container.is(':empty'));
        this.problem_button = this.$(this.problem_button_sel);
        this.problem_button.click(this.show_results);
        this.problem_list = this.$(this.problem_list_sel);
        this.construct_progress_bar();
      }
    }

    PeerGrading.prototype.$ = function(selector) {
      return $(selector, this.el);
    };

    PeerGrading.prototype.construct_progress_bar = function() {
      var problems,
        _this = this;
      problems = this.problem_list.find('tr').next();
      return problems.each(function(index, element) {
        var bar_max, bar_value, problem, progress_bar;
        problem = $(element);
        progress_bar = problem.find(_this.progress_bar_sel);
        bar_value = parseInt(problem.data('graded'));
        bar_max = parseInt(problem.data('required')) + bar_value;
        return progress_bar.progressbar({
          value: bar_value,
          max: bar_max
        });
      });
    };

    PeerGrading.prototype.show_results = function(event) {
      var data, location_to_fetch,
        _this = this;
      location_to_fetch = $(event.target).data('location');
      data = {
        'location': location_to_fetch
      };
      return $.postWithPrefix("" + this.ajax_url + "problem", data, function(response) {
        var backend;
        if (response.success) {
          _this.peer_grading_outer_container.after(response.html).remove();
          backend = new PeerGradingProblemBackend(_this.ajax_url, false);
          return new PeerGradingProblem(backend, _this.el);
        } else {
          return _this.gentle_alert(response.error);
        }
      });
    };

    PeerGrading.prototype.activate_problem = function() {
      var backend;
      backend = new PeerGradingProblemBackend(this.ajax_url, false);
      return new PeerGradingProblem(backend, this.el);
    };

    return PeerGrading;

  })();

}).call(this);
